<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pineapple OFC Poker</title>
  <style>
    :root {
      --card-width: 70px;
      --card-height: 100px;
      --red-suit: #e74c3c;
      --black-suit: #2c3e50;
      --primary: #27ae60;
      --secondary: #731b4f;
            --dark-bg: #1a6b1a;
      --light-bg: #0d4d0d;
      --error: #e74c3c;
      --warning: #f39c12;
    }

    * {
      box-sizing: border-box;
  }
      

    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--dark-bg);
      color: white;
      line-height: 1.6;
      pading: 0px;
      margin:0;
    }

    

    h1, h2 {
      text-align: center;
      margin-bottom: 15px;
    }

    /* Lobby styles */
    .lobby {
      background-color: var(--light-bg);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      display:none;
    }

    .player-list {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 15px 0;
    }

    .player-badge {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-badge.ready::after {
      content: '✓';
      color: var(--secondary);
    }

    /* Game area */
   
    .game-area {
      display:grid;
			grid-template-columns:calc(100% / 3) 33.33% 33.33%;
      border:10px solid yellow;
      width:100%;
      height:calc(100vh - 150px);
      
    }
    @media screen and (max-width: 452px) and (orientation: portrait){
		.game-area{
			display:block;
			height:100vh;
		}
	}
 section.player-area-box{
		border:4px solid brown;
		width:100%;
		height:auto;
	}
	section.player-area-box.second{
		position:relative;
	}
    .player-area {
      background-color: var(--light-bg);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      position: relative;
      border:3px solid white;
      width:100%;
    
    }
.player-area.second{
	background:blue;
	psition:absolute;
	bottom:0;

}
 /* Hand area */
    .hand {
		position:absolute;
		background:blue;
		top:110px;
		left:0;
		width:100%;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
      mn-height: calc(2 * var(--card-height));
    }
 @media screen and (max-width: 452px) and (orientation: portrait){
		.hand{
			dsplay:block;
			position:relative;
			margin:0;
			top:0;
			height:100%;
		}
		.player-area-box.second{
			z-index:100;
			display:block;
			position:relative;
			height:100px;
		}
		
	}
    div.board.first {
      argin: 15px 0;
      bckground:red;
    }

    .board-row {
      display: flex;
      justify-content: center;
      gap: 5px;
      mrgin-bottom: 30px;
    
      position: relative;
    }
.board-row.f{
	justify-content:start;
}
.board-row.t{
	justify-content:end;
}
    .board-slot {
      width: var(--card-width);
      height: var(--card-height);
      border: 2px dashed rgba(255, 255, 255, 0.3);
      border-radius: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s;
    }

    .board-slot.highlight {
      background-color: rgba(255, 255, 0, 0.2);
      border-color: yellow;
      cursor: pointer;
    }

    /* Card styles */
    .card {
      width: var(--card-width);
      height: var(--card-height);
      background-color: white;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 5px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      user-select: none;
    }

    .card.red {
      color: var(--red-suit);
    }

    .card.black {
      color: var(--black-suit);
    }

    .card.selected {
      transform: translateY(-10px);
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
    }

    .card.small {
      width: 40px;
      height: 60px;
      font-size: 0.8em;
    }

    .card-value {
      font-size: 1.2rem;
    }

    .card-suit {
      font-size: 1.5rem;
      text-align: center;
    }

   

    /* Discard area */
    .discard-area {
      margin-top: 15px;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }
    .discard-area.second{
		position:absolute;
		bottom:0;
		left:-300px;
		width:calc(4 * var(--card-width));
		background:red;
	}

    .discard-title {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .discard-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      min-height: 60px;
    }

    /* Status area */
    .status {
      text-align: center;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      margin: 10px 0;
      font-weight: bold;
    }

    .score {
      font-size: 1.2rem;
      text-align: center;
      margin: 10px 0;
    }

    /* Combination indicators  dopochko scoretotal*/
    .royalscore,.rowscore, .dohodscore, .dopochko, .scoretotal{
		background:lightblue;
		width:auto;
		height:22px;
		
		min-width:34px;
		position:absolute;
		top:0;
		right:4px;
		text-align:center;
		color:red;
		border-radius:1px;
	}
	.royalscore{
		top:0;
		right:4px;
	}
	.rowscore{
		top:35px;
		right:-40px;
	}
	.dohodscore{
		top:35px;
		right:-90px;
	}
	.dopochko{
		top:130px;
		right:20px;
	}
	.scoretotal{
		top: 150px;
		right:208px;
	}
	[data-royt],[data-roym],[data-royb]{
		position:relative;
	}
    .combo-indicator {
      position: absolute;
      bottom:12px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      display:block;
      z-index:10;
      background:rgba(35,55,24, 0.5);
      line-height:1.6;
      width:calc(3 * var(--card-width));
    }
	.combo-indicator.left{
		text-align: left;
		padding-left:10px;
		margin-left:5px;
	}
    .combo-good {
      color: var(--secondary);
    }

    .combo-bad {
      color: var(--error);
    }

    .combo-warning {
      color: var(--warning);
    }

    /* Error messages */
    .error-message {
      color: var(--error);
      text-align: center;
      margin: 5px 0;
      font-weight: bold;
      animation: shake 0.5s;
    }
    
    .player-area div {
  margin: 3px 0;
  font-size: 14px;
}

.player-area div:nth-child(1) {
  font-weight: bold;
  font-size: 16px;
}

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* Controls */
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background-color: var(--primary);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      background-color: var(--secondary);
    }

    button:disabled {
      background-color: #7f8c8d;
      cursor: not-allowed;
    }

    input {
      padding: 10px;
      border: none;
      border-radius: 5px;
      min-width: 200px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      :root {
        --card-width: 50px;
        --card-height: 75px;
      }

      .card-value {
        font-size: 0.9rem;
      }

      .card-suit {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <!--<div class="container">-->
    <h1>Pineapple OFC Poker</h1>
    
    <!-- Lobby Section -->
    <div class="lobby" id="lobby">
      <h2>Game Lobby</h2>
      <div class="player-list" id="playerList">
        <!-- Players will appear here -->
      </div>
      <div class="controls">
        <input type="text" id="playerName" placeholder="Your name" maxlength="15">
        <button id="joinBtn">Join Game</button>
        <button id="readyBtn" disabled>Ready</button>
      </div>
    </div>
    <button onclick="goready(this);">start a game</button>
    <output id="out"></output>
    <div id="gameStatus"></div>
    <!-- Game Area (hidden initially) -->
    <div class="game-area" id="gameArea">
      <!-- Opponent Board -->
      <section class="player-area-box">
      <div class="player-area">
        <div class="board first" id="opponentBoard"><div class="fishka" style="display:none;" id="fishkaer">&#127922;</div>
          <div class="board-row f" data-row="top">
            <div class="board-slot" data-pos="0"></div>
            <div class="board-slot" data-pos="1"></div>
            <div class="board-slot" data-pos="2" data-royt="1"></div>
            <!--<div class="combo-indicator combo-good left">Full House</div> -->
          </div>
          <div class="board-row f" data-row="middle">
            <div class="board-slot" data-pos="0"></div>
            <div class="board-slot" data-pos="1"></div>
            <div class="board-slot" data-pos="2"></div>
            <div class="board-slot" data-pos="3"></div>
            <div class="board-slot" data-pos="4" data-roym="1">
            </div>
          </div>
          <div class="board-row f" data-row="bottom">
            <div class="board-slot" data-pos="0"></div>
            <div class="board-slot" data-pos="1"></div> 
            <div class="board-slot" data-pos="2"></div>
            <div class="board-slot" data-pos="3"></div>
            <div class="board-slot" data-pos="4" data-royb="1">
				<div class="dopochko">+12</div><div class="scoretotal">+23</div> 
				</div>
				</div>
        <div class="discard-area">
          <div class="discard-cards" id="opponentDiscards"></div>
        </div>
      <div id="opponentFol"></div>
      
      </div>
      </div>
      </section>
       <section class="player-area-box second">
		
        <div class="hand" id="playerHand"></div>
     
      <!-- Current Player Board -->
    <!--  <div class="player-area second">
        <div class="board second" id="playerBoard">
          <div class="board-row f" data-row="top">
            <div class="board-slot" data-pos="0"></div>
            <div class="board-slot" data-pos="1"></div>
            <div class="board-slot" data-pos="2" data-royt="2">
				</div>
          </div>
          <div class="board-row f" data-row="middle">
            <div class="board-slot" data-pos="0"></div>
            <div class="board-slot" data-pos="1"></div>
            <div class="board-slot" data-pos="2"></div>
            <div class="board-slot" data-pos="3"></div>
            <div class="board-slot" data-pos="4" data-roym="2">
				</div>
          </div>
          <div class="board-row f" data-row="bottom">
            <div class="board-slot" data-pos="0"></div>
            <div class="board-slot" data-pos="1"></div>
            <div class="board-slot" data-pos="2"></div>
            <div class="board-slot" data-pos="3"></div>
            <div class="board-slot" data-pos="4" data-royb="2"> -->
				<!--<div class="dopochko">+12</div><div class="scoretotal">-23</div> --> 
				<!--</div>
          </div>
       
 
        <div class="discard-area second">
          <div class="discard-cards" id="playerDiscards"></div>
        </div>
        </div>
      </div> -->
      </section>
       <section class="player-area-box">
      <div class="player-area">
        <div class="board third" id="playerBoard"><div class="fishka" style="display:none;" id="fishkayou">&#127922;</div>
          <div class="board-row f" data-row="top">
            <div class="board-slot" data-pos="0"></div>
            <div class="board-slot" data-pos="1"></div>
            <div class="board-slot" data-pos="2" data-royt="2"></div>
          </div>
          <div class="board-row f" data-row="middle">
            <div class="board-slot" data-pos="0"></div>
            <div class="board-slot" data-pos="1"></div>
            <div class="board-slot" data-pos="2"></div>
            <div class="board-slot" data-pos="3"></div>
            <div class="board-slot" data-pos="4" data-roym="2"></div>
          </div>
          <div class="board-row f" data-row="bottom">
            <div class="board-slot" data-pos="0"></div>
            <div class="board-slot" data-pos="1"></div>
            <div class="board-slot" data-pos="2"></div>
            <div class="board-slot" data-pos="3"></div>
            <div class="board-slot" data-pos="4" data-royb="2"></div>
          </div>
        
        
        <div class="discard-area">
          <div class="discard-cards" id="playerDiscards"></div>
        </div><div id="playerFol"></div>
        </div>
      </div>
      </section>
    
  </div>

  <script>
	 // alert(1%2)
    // DOM Elements
    var AMPER = 0;
    const lobbyEl = document.getElementById('lobby');
    const gameAreaEl = document.getElementById('gameArea');
    const playerListEl = document.getElementById('playerList');
    const joinBtn = document.getElementById('joinBtn');
    const readyBtn = document.getElementById('readyBtn');
    const playerNameInput = document.getElementById('playerName');
    const playerNameDisplay = document.getElementById('playerNameDisplay');
    const opponentNameEl = document.getElementById('opponentName');
    const playerScoreEl = document.getElementById('playerScore');
    const opponentScoreEl = document.getElementById('opponentScore');
    const gameStatusEl = document.getElementById('gameStatus');
    const errorMessageEl = document.getElementById('errorMessage');
    const playerHandEl = document.getElementById('playerHand');
    const playerBoardEl = document.getElementById('playerBoard');
    const opponentBoardEl = document.getElementById('opponentBoard');
    const playerDiscardsEl = document.getElementById('playerDiscards');
    const opponentDiscardsEl = document.getElementById('opponentDiscards')
    var SUBTYPE=null;
    // Game state
    let playerId = null;
    let selectedCard = null;
    let ws = null;
let gameState = null; 
function goready(el){
	//alert('ready')
	
	let a = document.querySelectorAll(".scoretotal");
	a.forEach(function(el, i){
		el.remove()
	})
	let b = document.querySelectorAll(".rowscore");
	
	b.forEach(function(el, i){
		el.remove()
	})
	let c = document.querySelectorAll(".dopochko");//"royalscore" dohodscore   <div class="card-value">${card.rank}</div> <div class="card-suit">${card.suit}</div>
	c.forEach(function(el, i){
		el.remove()
	})
	let d = document.querySelectorAll(".royalscore");
	d.forEach(function(el, i){
		el.remove()
	})
	let e = document.querySelectorAll(".dohodscore");
	e.forEach(function(el, i){
		el.remove()
	})
	let f = document.querySelectorAll(".card-value");
	f.forEach(function(el, i){
		el.remove()
	})
	let g = document.querySelectorAll(".card-suit");
	g.forEach(function(el, i){
		el.remove()
	})
	opponentFol.innerHTML = "";
	playerFol.innerHTML = "";
	fishkayou.style.display = "none";
	fishkaer.style.display = "none";
	AMPER=1;
	/*
	ws.send(JSON.stringify({
        action: 'join',
        name: 'alik'
      }));*/
      ws.send(JSON.stringify({
        action: 'ready'
      }));
	
}
    // Initialize WebSocket
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const host = window.location.host;
      ws = new WebSocket(`${protocol}//${host}`);

      ws.onopen = () => {
        console.log('Connected to server');
          ws.send(JSON.stringify({
        action: 'join',
        name: 'alik'
      }));
      ws.send(JSON.stringify({
        action: 'ready'
      }));
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('Received:', data);
        handleMessage(data);
      };

      ws.onclose = () => {
        console.log('Disconnected from server');
      //  alert('Connection lost. Please refresh the page.');
      };
    }

    // Message handler
    function handleMessage(data) {
      switch (data.type) {
        case 'lobby':
          updateLobby(data);
          break;
        case 'joined':
          handleJoined(data);
          break;
        case 'gameState':
          updateGameState(data);
          if(data.phase=='fantasyPlacing'){
			 
		  }
          break;
        case 'error':
          showError(data.message);
          break;
           case 'fantasyStart':
          // alert('fantasyStart')
           
      //showFantasyNotification(data.playerId);
     // fantasyClick(data);
    //  goready()
     if(data.playerId==playerId){
				  showFantasyNotification(playerId);
				  SUBTYPE = true;
			  }
      break;
      case 'fucker':
     // alert(JSON.stringify(data));
  //  if(AMPER == 0){
      if(data.fishka == playerId){
		  fishkayou.style.display = "block";//opponent hod
		  fishkaer.style.display='none'
	  }else{
		  fishkaer.style.display = "block";//you hod
		  fishkayou.style.display='none'
	  }
	 AMPER = 1;
//}else{
	 /* if(data.fishka == playerId){
		  fishkaer.style.display = "block";
	  }else{
		  fishkayou.style.display = "block";
	  }*/
	  AMPER = 0;
  //}
      break;
      
      }
    }
    
function showFantasyNotification(playerId) {
  if (playerId === playerId) {
    gameStatusEl.innerHTML = `
      <div style="color: gold; font-weight: bold; animation: pulse 1s infinite;">
        ВЫ ИГРАЕТЕ ФАНТАЗИЮ! Получите 14 карт
      </div>
    `;
  } else {
    gameStatusEl.innerHTML = `
      <div style="color: orange;">
        Оппонент играет фантазию. Будьте внимательны!
      </div>
    `;
  }
}

/*
// В функции updateGameState()
if (data.phase === 'fantasyDiscard' && data.playerId === playerId) {
  gameStatusEl.innerHTML = `
    <div style="color: gold; font-weight: bold;">
      Выберите 1 карту из 14 для сброса
    </div>
  `;
    const cards = playerHandEl.querySelectorAll('.card');
  cards.forEach(card => {
    card.onclick = function() {
      ws.send(JSON.stringify({
        action: 'fantasyDiscard',
        cardId: this.dataset.id
      }));
    };
  });
}
*/
    // Lobby functions
    function updateLobby(data) {
	//	alert(JSON.stringify(data))
      playerListEl.innerHTML = '';
      data.players.forEach(player => {
        const playerEl = document.createElement('div');
        playerEl.className = `player-badge ${player.ready ? 'ready' : ''}`;
        playerEl.textContent = player.name;
        playerListEl.appendChild(playerEl);
      });

      readyBtn.disabled = (!playerId || data.players.length<1);
    }

    function handleJoined(data) {
      playerId = data.playerId;
    //  playerNameDisplay.textContent = playerNameInput.value || 'You';
      joinBtn.disabled = true;
      readyBtn.disabled = false;
    }
function deleteData(){
	let eli = document.querySelectorAll('[data-del=1]');
	for(var i; i < eli.length;i++){
		let el = eli[i];
		if(el)el.remove();
	}
}
    // Game state functions
    function updateGameState(data) {
		//if(data.phase=='discarding'){alert('discarding')}
		 gameState = data;
      // Show game area if we were in lobby
      if (data.phase !== 'waiting') {
        lobbyEl.style.display = 'none';
       // gameAreaEl.style.display = 'block';
      }

      // Update player hand
      updatePlayerHand(data.player.hand);

      // Update boards
      updateBoard(data.player.board, playerBoardEl, true, data.player.combinations);
      if (data.opponent) {
       
        updateBoard(data.opponent.board, opponentBoardEl, false, data.opponent.combinations);
      
      }

     

      // Update discards
      updateDiscards(data.player.discards, playerDiscardsEl);
      if (data.opponent) {
        updateDiscards(data.opponent.discards, opponentDiscardsEl);
      }

      // Update game status
      updateGameStatus(data);
      /*
      if (data.phase === 'fantasyDiscard' && data.playerId === playerId) {
 // gameStatusEl.innerHTML = ' <div style="color: gold; font-weight: bold;">  Выберите 1 карту из 14 для сброса </div>';
  
    const cards = playerHandEl.querySelectorAll('.card');
  cards.forEach(card => {
    card.onclick = function() {
      ws.send(JSON.stringify({
        action: 'fantasyDiscard',
        cardId: this.dataset.id
      }));
    };
  });
  
}
      
   */   
     // alert(data.round)
      
      if(selectedCard){
		  var selectedCardEl = playerHand.querySelector(`.card[data-id="${selectedCard}"]`);
		  if(selectedCardEl){
			  selectCardEl.classList.remove('selected')
		  }
		  selectedCard = null;
		  clearHighlights()
	  }
    
  if(data.phase==='placing' && data.currentPlayer===playerId){
	  activateCardHandlers()
  }
  // Отображаем информацию о линиях и бонусах
  if (data.player) {
	  console.warn('data.player ', data.player)
    
    if(data.player.lineWins.bottom&&data.player.lineWins.bottom.iswin){
    
		  insertOchko(data.player, 'bottom', '[data-royb="2"]',"+")
	  }else{
		  insertOchko(data.player, 'bottom', '[data-royb="2"]')
	  }
   if(data.player.lineWins.middle&&data.player.lineWins.middle.iswin){
    
		  insertOchko(data.player, 'middle', '[data-roym="2"]',"+")
	  }else{
		  insertOchko(data.player, 'middle', '[data-roym="2"]')
	  }
	  
	   if(data.player.lineWins.top&&data.player.lineWins.top.iswin){
    
		  insertOchko(data.player, 'top', '[data-royt="2"]',"+")
	  }else{
		  insertOchko(data.player, 'top', '[data-royt="2"]')
	  }
	  if(data.player.dopochko){
		  let a = document.querySelector('[data-royb="2"]');
		  let div = document.createElement('div');
		  div.className = "dopochko";
		  div.setAttribute('data-del', 1);
		  div.textContent = data.player.dopochko;
		  if(a)a.appendChild(div);
	  }
	   if(data.player.score){
		  let a = document.querySelector('[data-royb="2"]');
		  let div = document.createElement('div');
		  div.className = "scoretotal";
		  div.setAttribute('data-del', 1);
		  div.textContent = (data.player.score > 0?"+":"") + data.player.score;
		  if(a)a.appendChild(div);
	  }
    if(data.player.foulMessage){
		//playerFol
		playerFol.textContent = "dead hand";//data.foulMessage;
	}
	
  }else{
	  console.log(data.player)
  }
  
  if (data.opponent) {
	  console.warn('data.opponent ', data.opponent)
     if(data.opponent.lineWins.bottom&&data.opponent.lineWins.bottom.iswin){
    
		  insertOchko(data.opponent, 'bottom', '[data-royb="1"]',"+")
	  }else{
		  insertOchko(data.opponent, 'bottom', '[data-royb="1"]')
	  }
   if(data.opponent.lineWins.middle&&data.opponent.lineWins.middle.iswin){
    
		  insertOchko(data.opponent, 'middle', '[data-roym="1"]',"+")
	  }else{
		  insertOchko(data.opponent, 'middle', '[data-roym="1"]')
	  }
	  
	   if(data.opponent.lineWins.top&&data.opponent.lineWins.top.iswin){
    
		  insertOchko(data.opponent, 'top', '[data-royt="1"]',"+")
	  }else{
		  insertOchko(data.opponent, 'top', '[data-royt="1"]')
	  }
	   if(data.opponent.dopochko){
		  let a = document.querySelector('[data-royb="1"]');
		  let div = document.createElement('div');
		  div.className = "dopochko";
		  div.setAttribute('data-del', 1);
		  div.textContent = data.opponent.dopochko;
		  if(a)a.appendChild(div);
	  }
	  if(data.opponent.score){
		  let a = document.querySelector('[data-royb="1"]');
		  let div = document.createElement('div');
		  div.className = "scoretotal";
		  div.setAttribute('data-del', 1);
		  div.textContent = (data.opponent.score > 0?"+":"") + data.opponent.score;
		  if(a)a.appendChild(div);
	  }
	 // if(data.opponent.hasFoul)alert('has foul')
    if(data.opponent.foulMessage){
		//alert('foulmessage')
		opponentFol.textContent = "dead hand";// data.foulMessage;
	}
  }else{
	  console.error(data.opponent)
  }

      
     
  // ... существующий код ...

  // Отображаем детализированные бонусы
  if (data.player) {
    let royaltiesInfo = '';
    if (data.player.royalties) {
      const r = data.player.royalties;
      //const d = data.opponent.royalties;
     // if(!r.top || !r.middle || !r.bottom)return;
     //alert(JSON.stringify(r.top))
      royaltiesInfo = [
        r.top.description,
        r.middle.description,
        r.bottom.description
      ].filter(d => d).join(' | ');
      if(r.top.amount&&r.top.amount > 0){
		  let a = document.querySelector('[data-royt="2"]');
		  let div = document.createElement('div');
		  div.className = "royalscore";
		  div.setAttribute('data-del', 1);
		  div.textContent = (r.top.amount > 0?"+":"") + r.top.amount;
		  if(a)a.appendChild(div);
		  
}
//"royalscore" dohodscore
		  if(r.top.dohodscore){
		   let c = document.querySelector('[data-royt="2"]');
		  let div3 = document.createElement('div');
		  div3.className = "dohodscore";
		  div3.setAttribute('data-del', 1);
		  div3.textContent = (r.top.dohodscore > 0?"+":"") + r.top.dohodscore;
		  if(c)c.appendChild(div3);
	  }
		  /*
		  let b = document.querySelector('[data-royt="1"]');
		  let div2 = document.createElement('div');
		  div2.className = "dohodscore";
		  div2.textContent =  (d.top.amount > 0?"+":"") + d.top.amount;
		  if(b)b.appendChild(div2);*/
	  
	  if(r.middle.amount&&r.middle.amount > 0){
		  let a = document.querySelector('[data-roym="2"]');
		  let div = document.createElement('div');
		  div.className = "royalscore";
		  div.setAttribute('data-del', 1);
		  div.textContent = (r.middle.amount > 0?"+":"") + r.middle.amount;
		  if(a)a.appendChild(div);
	  }
		  if(r.middle.dohodscore){
		   let c = document.querySelector('[data-roym="2"]');
		  let div3 = document.createElement('div');
		  div3.className = "dohodscore";
		  div3.setAttribute('data-del', 1);
		  div3.textContent = (r.middle.dohodscore > 0?"+":"") + r.middle.dohodscore;
		  if(c)c.appendChild(div3);
	  }
		  /*
		  let b = document.querySelector('[data-roym="1"]');
		  let div2 = document.createElement('div');
		  div2.className = "dohodscore";
		  div2.textContent =  (d.middle.amount > 0?"+":"") + d.middle.amount;
		  if(b)b.appendChild(div2);*/
	  
	  if(r.bottom.amount&&r.bottom.amount > 0){
		  let a = document.querySelector('[data-royb="2"]');
		  let div = document.createElement('div');
		  div.className = "royalscore";
		  div.setAttribute('data-del', 1);
		  div.textContent = (r.bottom.amount > 0?"+":"") + r.bottom.amount;
		  if(a)a.appendChild(div);
	  }
		  if(r.bottom.dohodscore){
		   let c = document.querySelector('[data-royb="2"]');
		  let div3 = document.createElement('div');
		  div3.className = "dohodscore";
		  div3.setAttribute('data-del', 1);
		  div3.textContent = (r.bottom.dohodscore > 0?"+":"") + r.bottom.dohodscore;
		  if(c)c.appendChild(div3);
	  }
		  
	  
    }
  
    
  }
  
  if (data.opponent) {
    let royaltiesInfo = '';
    if (data.opponent.royalties) {
      const r = data.opponent.royalties;
    //  if(!r.top || !r.miffle || !r.bottom) return;
      royaltiesInfo = [
        r.top.description,
        r.middle.description,
        r.bottom.description
      ].filter(d => d).join(' | ');
      if(r.top.amount&&r.top.amount > 0){
		  let a = document.querySelector('[data-royt="1"]');
		  let div = document.createElement('div');
		  div.className = "royalscore";
		  div.setAttribute('data-del', 1);
		  div.textContent = "+" + r.top.amount;
		  if(a)a.appendChild(div);
	  }
		  if(r.top.dohodscore){
		   let c = document.querySelector('[data-royt="1"]');
		  let div3 = document.createElement('div');
		  div3.className = "dohodscore";
		  div3.setAttribute('data-del', 1);
		  div3.textContent = (r.top.dohodscore > 0?"+":"") + r.top.dohodscore;
		  if(c)c.appendChild(div3);
	  }
		 
	  
	  if(r.middle.amount&&r.middle.amount > 0){
		  let a = document.querySelector('[data-roym="1"]');
		  let div = document.createElement('div');
		  div.className = "royalscore";
		  div.setAttribute('data-del', 1);
		  div.textContent = "+" + r.middle.amount;
		  if(a)a.appendChild(div);
	  }
		  if(r.middle.dohodscore){
		  let c = document.querySelector('[data-roym="1"]');
		  let div3 = document.createElement('div');
		  div3.setAttribute('data-del', 1);
		  div3.className = "dohodscore";
		  div3.textContent = (r.middle.dohodscore > 0?"+":"") + r.middle.dohodscore;
		  if(c)c.appendChild(div3);
	  }
		 
	  
	  if(r.bottom.amount&&r.bottom.amount > 0){
		  let a = document.querySelector('[data-royb="1"]');
		  let div = document.createElement('div');
		  div.className = "royalscore";
		  div.setAttribute('data-del', 1);
		  div.textContent = "+" + r.bottom.amount;
		  if(a)a.appendChild(div);
	  }
		  if(r.bottom.dohodscore){
		  let c = document.querySelector('[data-royb="1"]');
		  let div3 = document.createElement('div');
		  div3.className = "dohodscore";
		  div3.setAttribute('data-del', 1);
		  div3.textContent = (r.bottom.dohodscore > 0?"+":"") + r.bottom.dohodscore;
		  if(c)c.appendChild(div3);
	  }
		 
	  
    }
    
  }
 // updateTurnInfo(data)
}
function updateTurnInfo(data){
	if(data.isFirstPlayer){
	//	alert('u vac fishka next turn')
	out.innerHTML = "Вы ходите первым в этой игре"
	}else{
		out.innerHTML = "оппонент ходит первым в этой игре"
	//	alert('fishka u oponenta')
	}
}
function getLineWinsText(lineWins) {
  if (!lineWins) return '';
  return [
    lineWins.top ? 'Top' : '',
    lineWins.middle ? 'Middle' : '',
    lineWins.bottom ? 'Bottom' : ''
  ].filter(l => l).join('+') || 'None';
}
      
      
      
      
      function insertOchko(data, level, n, znak){
		//  console.warn(data)
		  if(!data.lineWins[level])return;
		   let a = document.querySelector(n);
		  let div = document.createElement('div');
		  div.className = "rowscore";
		  div.setAttribute('data-del', 1)
		  if(data.lineWins[level].ochko==0)return;
		  div.textContent =  (znak&&znak=='+'?"+":"") + data.lineWins[level].ochko;
		  if(a)a.appendChild(div);
	  }
      
      
      
      
      function activateCardHandlers() {
  alert('Activating card handlers for current player');
  
  const cards = playerHandEl.querySelectorAll('.card');
  cards.forEach(card => {
    // Удаляем старые обработчики через клонирование
    const newCard = card.cloneNode(true);
    card.parentNode.replaceChild(newCard, card);
  });
  
  // Добавляем новые обработчики на свежие элементы
  const newCards = playerHandEl.querySelectorAll('.card');
  newCards.forEach(card => {
    card.addEventListener('click', () => {
      console.log('Card clicked:', card.dataset.id);
      const cardId = card.dataset.id;
      selectCard(card, cardId);
    });
  });
  
  console.log(`Card handlers activated for ${newCards.length} cards`);
}
      
    
/*
    function updatePlayerHand(hand) {
      playerHandEl.innerHTML = '';
      if (hand) {
        hand.forEach(card => {
          if (card) {
            const cardEl = createCardElement(card);
            playerHandEl.appendChild(cardEl);
          }
        });
      }
    }
*/
    function updateBoard(board, boardEl, isInteractive, combinations) {
      for (const row of ['top', 'middle', 'bottom']) {
        const rowEl = boardEl.querySelector(`[data-row="${row}"]`);
        const slots = rowEl.querySelectorAll('.board-slot');
        
        // Clear existing combo indicators
        const existingCombo = rowEl.querySelector('.combo-indicator');
        if (existingCombo) rowEl.removeChild(existingCombo);

        // Add combo indicator if exists
        if (combinations && combinations[row]) {
          const comboEl = document.createElement('div');
          comboEl.className = 'combo-indicator combo-good left';
          comboEl.textContent = combinations[row].name;
          rowEl.appendChild(comboEl);
        }

        // Update cards in slots
        board[row].forEach((card, index) => {
          const slot = slots[index];
          slot.innerHTML = '';
          
          if (card) {
            const cardEl = createCardElement(card);
            slot.appendChild(cardEl);
          }
          
          // Make slots interactive if it's player's turn
          if (isInteractive && 
              !card && 
              selectedCard !== null &&
              boardEl === playerBoardEl &&
              gameState.phase === 'placing') {
            slot.classList.add('highlight');
            slot.onclick = () => placeCard(row, index);
          } else {
            slot.classList.remove('highlight');
            slot.onclick = null;
          }
        });
      }
    }

    function updateDiscards(discards, container) {
	//	return;
      container.innerHTML = '';
      discards.forEach(card => {
        const cardEl = createCardElement(card);
        cardEl.classList.add('small');
        container.appendChild(cardEl);
      });
    }

    function updateGameStatus(data) {
		console.log('update status', data)
      let statusText = '';
      gameState = data; 
      switch (data.phase) {
        case 'waiting':
          statusText = 'Waiting for players...';
          break;
        case 'dealing':
          statusText = 'Dealing cards...';
          break;
        case 'placing':
        //  statusText = `Place ${data.cardsToPlace} card(s) on your board`;
        if(data.currentPlayer === playerId){
			//alert("your turn "+ playerId)
		}else{
			//alert("opponents turn")
		}
          break;
        case 'discarding':
        if(data.currentPlayer === playerId){
          statusText = 'Select a card to discard';
         // setupDiscardPhase();
	  }
          break;
          case 'fantasyDiscard':
          if(data.currentPlayer === playerId){
		//	  setupFantasyDiscardPhase()
		  }
        case 'scoring':
          statusText = 'Game over! Calculating scores...';
          break;
      }
      
    //  gameStatusEl.textContent = statusText;
    }

    function setupDiscardPhase() {
      const cards = playerHandEl.querySelectorAll('.card');
      cards.forEach(card => {
        card.onclick = function() {
          ws.send(JSON.stringify({
            action: 'discard',
            cardId: this.dataset.id
          }));
        };
      });
    }

    // Card functions
    function createCardElement(card) {
		//alert(2)
	//console.log(card)
      if (!card) return null;
      
      const cardEl = document.createElement('div');
      cardEl.className = `card ${['♥', '♦'].includes(card.suit) ? 'red' : 'black'}`;
      cardEl.dataset.id = card.id;
      cardEl.setAttribute('data-fuck', 'fucking')
      cardEl.innerHTML = `
        <div class="card-value">${card.rank}</div>
        <div class="card-suit">${card.suit}</div>
      `;
      /*
     // if (window.gameState && window.gameState.phase === 'placing') {
		 
        cardEl.addEventListener('click', () => {
			if(gameState && gameState.phase === 'placing' ||
			gameState.phase === 'discarding' ||
			gameState.phase  === 'fantasyDiscard' &&
			gameState.currentPlayer === playerId) {
			console.log(cardEl, card.id)
        selectCard(cardEl, card.id)
	}
        });
	
	*/
      
      return cardEl;
    }

function handleCardClick(cardEl, cardId) {
  if (!gameState) {
    console.log('No game state');
    return;
  }

  console.log('Card clicked:', cardId, 'Phase:', gameState.phase, 'Current player:', gameState.currentPlayer);

  // Проверяем, может ли игрок сейчас делать ход
  const canInteract = 
    (gameState.phase === 'fantasyPlacing') || // В фантазии оба игрока могут ходить
    (gameState.currentPlayer === playerId && gameState.phase === 'placing') ||
    (gameState.currentPlayer === playerId && gameState.phase === 'discarding') ||
    (gameState.currentPlayer === playerId && gameState.phase === 'fantasyFinalDiscard');

  if (!canInteract) {
    console.log('Cannot interact now');
    //return;
  }
//alert(SUBTYPE)
  console.error(' Обработка разных фаз ', gameState.phase)
  switch (gameState.phase) {
    case 'fantasyPlacing':
    case 'placing': 

      handleCardSelection(cardEl, cardId);
      break;
      
    case 'discarding':
    case 'fantasyFinalDiscard':
      handleCardDiscard(cardId);
      break;
  }
}

function handleCardSelection(cardEl, cardId) {
	//alert(33)
  // Если уже выбрана эта карта - снимаем выделение
  if (selectedCard === cardId) {
    cardEl.classList.remove('selected');
    selectedCard = null;
    clearHighlights();
    return;
  }

  // Снимаем выделение с предыдущей карты
  if (selectedCard) {
    const prevSelected = playerHandEl.querySelector(`.card[data-id="${selectedCard}"]`);
    if (prevSelected) prevSelected.classList.remove('selected');
  }

  // Выделяем новую карту
  cardEl.classList.add('selected');
  selectedCard = cardId;

  // Подсвечиваем доступные слоты
  highlightValidSlots();
}

function handleCardDiscard(cardId) {
//	alert('discard'+cardId)
  // Определяем какое действие отправлять
  let action = 'discard';
  if (gameState.phase === 'fantasyFinalDiscard') {
    if(SUBTYPE)action = 'fantasyDiscard';
  }

  //alert(`Sending ${action} for card:`+ cardId);
  
  ws.send(JSON.stringify({
    action: action,
    cardId: cardId
  }));

  // Снимаем выделение
  const selectedCardEl = playerHandEl.querySelector(`.card[data-id="${cardId}"]`);
  if (selectedCardEl) {
    selectedCardEl.classList.remove('selected');
  }
  selectedCard = null;
}


function selectCard(cardEl, cardId) {
	alert(5)
  if (!gameState) {
    console.log('No game state');
    return;
  }
alert(3)
  console.log('Select card called, phase:', gameState.phase, 'currentPlayer:', gameState.currentPlayer, 'playerId:', playerId);

  // ОБЫЧНЫЙ РЕЖИМ - размещение карт
  if (gameState.phase === 'placing' && gameState.currentPlayer === playerId) {
    console.log('Normal placing mode activated');
    
    // Если уже выбрана эта карта - снимаем выделение
    if (selectedCard === cardId) {
      cardEl.classList.remove('selected');
      selectedCard = null;
      clearHighlights();
      return;
    }

    // Снимаем выделение с предыдущей карты
    if (selectedCard) {
      const prevSelected = playerHandEl.querySelector(`.card[data-id="${selectedCard}"]`);
      if (prevSelected) prevSelected.classList.remove('selected');
    }

    // Выделяем новую карту
    cardEl.classList.add('selected');
    selectedCard = cardId;

    // Подсвечиваем доступные слоты
    highlightValidSlots();
    return;
  }

  // РЕЖИМ ФАНТАЗИИ - размещение карт (оба игрока могут)
  if (gameState.phase === 'fantasyPlacing') {
	  alert(2)
    console.log('Fantasy placing mode activated');
    
    if (selectedCard === cardId) {
      cardEl.classList.remove('selected');
      selectedCard = null;
      clearHighlights();
      return;
    }

    if (selectedCard) {
      const prevSelected = playerHandEl.querySelector(`.card[data-id="${selectedCard}"]`);
      if (prevSelected) prevSelected.classList.remove('selected');
    }

    cardEl.classList.add('selected');
    selectedCard = cardId;
    highlightValidSlots();
    return;
  }

  // РЕЖИМ СБРОСА КАРТ
  if ((gameState.phase === 'discarding' || gameState.phase === 'fantasyFinalDiscard') && 
      gameState.currentPlayer === playerId) {
    console.log('Discard mode activated');
    
    let actionType = 'discard';
    if (gameState.phase === 'fantasyFinalDiscard') {
      actionType = 'fantasyDiscard';
    }
    
    ws.send(JSON.stringify({
      action: actionType,
      cardId: cardId
    }));
    
    return;
  }

  console.log('Card selection not allowed in current state');
}

function fucking(){
	return;
	alert(1)
	//alert(this.dataset.id);
	//return;
      console.log('Card clicked:', this.dataset.id);
      alert('Card clicked: '+ this.dataset.id)
      let cardid=this.dataset.id;
      selectedCard=cardid;
      this.classList.add('selected')
      //highlight();
      const eli=document.querySelectorAll(".card");
	eli.forEach(card => {
		console.log('card ',card)
    //card.addEventListener('click', fucking,false);
   // fantasyClick()
})
    
}


function fantasyClick(data){
	const eli=document.querySelectorAll('[data-fuck="fucking"]');
	eli.forEach(card => {
   card.addEventListener('click', fucking,false);
   //card.onclick=fucking;
})
}


function updatePlayerHand(hand) {
  playerHandEl.innerHTML = '';
  if (hand) {
    hand.forEach(card => {
      if (card) {
        const cardEl = createCardElement(card);
        playerHandEl.appendChild(cardEl);
      }
    });
  }
  
  // Перепривязываем обработчики после обновления руки
  bindCardHandlers();
}

// Новая функция для привязки обработчиков
function bindCardHandlers() {
  const cards = playerHandEl.querySelectorAll('.card');
  cards.forEach(card => {
    // Удаляем старые обработчики (если есть)
    card.removeEventListener('click', card._clickHandler);
    
    // Создаем новый обработчик
    const clickHandler = () => {
      const cardId = card.dataset.id;
      handleCardClick(card, cardId);
    };
    
    // Сохраняем ссылку на обработчик для возможности удаления
    card._clickHandler = clickHandler;
    card.addEventListener('click', clickHandler);
  });
}


function highlight(){
	const slots = playerBoardEl.querySelectorAll('.board-slot:empty');
  console.log(`Found ${slots.length} empty slots to highlight`);
  
  slots.forEach(slot => {
    slot.classList.add('highlight');
    const row = slot.closest('.board-row').dataset.row;
    const pos = parseInt(slot.dataset.pos);
    
    slot.onclick = () => {
      console.log(`Placing card to ${row} row, position ${pos}`);
      
      // Определяем действие в зависимости от фазы
      let action = 'placeCard';
      
      ws.send(JSON.stringify({
        action: action,
        cardId: selectedCard,
        row: row,
        position: pos
      }));
      
      // Снимаем выделение после размещения
      const selectedCardEl = playerHandEl.querySelector(`.card[data-id="${selectedCard}"]`);
      if (selectedCardEl) {
        selectedCardEl.classList.remove('selected');
      }
      //selectedCard = null;
      //clearHighlights();
    };
  });
}
function highlightValidSlots() {
  clearHighlights();
  
  if (!selectedCard || !gameState) {
    console.log('No card selected or no game state');
    return;
  }

  // Проверяем, в какой фазе мы находимся
  const canPlaceCards = (gameState.phase === 'placing' && gameState.currentPlayer === playerId) || 
                       (gameState.phase === 'fantasyPlacing');
  
  if (!canPlaceCards) {
    console.log('Cannot place cards in current phase');
    return;
  }

  const slots = playerBoardEl.querySelectorAll('.board-slot:empty');
  console.log(`Found ${slots.length} empty slots to highlight`);
  
  slots.forEach(slot => {
    slot.classList.add('highlight');
    const row = slot.closest('.board-row').dataset.row;
    const pos = parseInt(slot.dataset.pos);
    
    slot.onclick = () => {
      console.log(`Placing card to ${row} row, position ${pos}`);
      let ba={}
      if(SUBTYPE){
		  ba.subtype='trueFantasy'
	  }
     // alert(99)
      // Определяем действие в зависимости от фазы
      let action = 'placeCard';
      ba.action=action;
      ba.cardId=selectedCard;
      ba.row=row;
      ba.position=pos;
      let suka=JSON.stringify(ba)
      //alert(suka)
      ws.send(suka);
      
      // Снимаем выделение после размещения
      const selectedCardEl = playerHandEl.querySelector(`.card[data-id="${selectedCard}"]`);
      if (selectedCardEl) {
        selectedCardEl.classList.remove('selected');
      }
      selectedCard = null;
      clearHighlights();
    };
  });
}




    function clearHighlights() {
      const slots = playerBoardEl.querySelectorAll('.board-slot');
      slots.forEach(slot => {
        slot.classList.remove('highlight');
        slot.onclick = null;
      });
    }
function placeCard(row, position) {
  if (!selectedCard) return;
  
  console.log('Placing card:', selectedCard, 'at:', row, position);
  let ba={}
  // Определяем действие в зависимости от фазы
  ba.action = 'placeCard';
  if (gameState.phase === 'fantasyPlacing') {
    b.action = 'placeCard'; // В фантазии используется тот же action
  }
  if(SUBTYPE){
	  ba.subtype='trueFantasy';
  }
  ba.cardIt = selectedCard;
  ba.row = row;
  ba.position = position;
  alert(JSON.stringify(ba))
  ws.send(JSON.stringify(ba));
  
  // Снимаем выделение
  const selectedCardEl = playerHandEl.querySelector(`.card[data-id="${selectedCard}"]`);
  if (selectedCardEl) {
    selectedCardEl.classList.remove('selected');
  }
  selectedCard = null;
  clearHighlights();
}


function showError(message) {
      errorMessageEl.textContent = message;
      //console.error(message)
   //   setTimeout(() => errorMessageEl.textContent = '', 3000);
    }

    function showOrderError(errors) {
      // Clear previous errors
      document.querySelectorAll('.combo-bad').forEach(el => el.classList.remove('combo-bad'));
      
      errors.forEach(error => {
        const rowEl = playerBoardEl.querySelector(`[data-row="${error.row}"]`);
        const comboEl = rowEl.querySelector('.combo-indicator') || document.createElement('div');
        comboEl.className = 'combo-indicator combo-bad';
        comboEl.textContent = error.message;
        rowEl.appendChild(comboEl);
      });
    }

    // Event listeners
    joinBtn.addEventListener('click', () => {
      const name = playerNameInput.value.trim() || `Player${Math.floor(Math.random() * 1000)}`;
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        connectWebSocket();
      }
      
      ws.send(JSON.stringify({
        action: 'join',
        name
      }));
    });

    readyBtn.addEventListener('click', () => {
      ws.send(JSON.stringify({
        action: 'ready'
      }));
      readyBtn.disabled = true;
    });

    // Initialize
    connectWebSocket();
  
  </script>
</body>
</html>

      
