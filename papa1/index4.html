<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Китайский покер (Человек vs Бот)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        .game-container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .player-area {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .player-name {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
        }
        .hand {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
            min-height: 100px;
        }
        .card {
            width: 60px;
            height: 90px;
            background-color: white;
            border: 1px solid #999;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            position: relative;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        .card.selected {
            border: 2px solid red;
            transform: translateY(-10px);
        }
        .card.hearts, .card.diamonds {
            color: red;
        }
        .card.spades, .card.clubs {
            color: black;
        }
        .card-back {
            background-color: #3366cc;
            color: white;
            font-size: 14px;
        }
        .fields {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .field {
            width: 30%;
            min-height: 150px;
            border: 1px dashed #999;
            border-radius: 5px;
            padding: 10px;
            background-color: #f5f5f5;
        }
        .field-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #45a049;
        }
        .scoreboard {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        .score-table {
            width: 100%;
            border-collapse: collapse;
        }
        .score-table th, .score-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .score-table th {
            background-color: #f2f2f2;
        }
        .message {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
            min-height: 20px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Китайский покер (Человек vs Бот)</h1>
        
        <div class="message" id="message">Начните новую игру</div>
        
        <div class="controls">
            <button id="newGameBtn">Новая игра</button>
            <button id="arrangeBtn" disabled>Распределить карты</button>
            <button id="playBtn" disabled>Сделать ход</button>
        </div>
        
        <div class="player-area">
            <div class="player-name">Бот</div>
            <div class="hand" id="botHand"></div>
            <div class="fields">
                <div class="field" id="botTop">
                    <div class="field-title">Верх (5 карт)</div>
                </div>
                <div class="field" id="botMiddle">
                    <div class="field-title">Середина (5 карт)</div>
                </div>
                <div class="field" id="botBottom">
                    <div class="field-title">Низ (3 карты)</div>
                </div>
            </div>
        </div>
        
        <div class="player-area">
            <div class="player-name">Вы</div>
            <div class="hand" id="playerHand"></div>
            <div class="fields">
                <div class="field" id="playerTop">
                    <div class="field-title">Верх (5 карт)</div>
                </div>
                <div class="field" id="playerMiddle">
                    <div class="field-title">Середина (5 карт)</div>
                </div>
                <div class="field" id="playerBottom">
                    <div class="field-title">Низ (3 карты)</div>
                </div>
            </div>
        </div>
        
        <div class="scoreboard">
            <h3>Результаты</h3>
            <table class="score-table">
                <tr>
                    <th>Раунд</th>
                    <th>Вы</th>
                    <th>Бот</th>
                </tr>
                <tbody id="scoreTable">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let deck = [];
        let playerHand = [];
        let botHand = [];
        let playerFields = { top: [], middle: [], bottom: [] };
        let botFields = { top: [], middle: [], bottom: [] };
        let currentRound = 0;
        let scores = [];
        let selectedCards = [];
        let currentField = null;

        // Масти карт
        const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
        const suitSymbols = { 'hearts': '♥', 'diamonds': '♦', 'clubs': '♣', 'spades': '♠' };
        const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];

        // Элементы DOM
        const playerHandEl = document.getElementById('playerHand');
        const botHandEl = document.getElementById('botHand');
        const playerTopEl = document.getElementById('playerTop');
        const playerMiddleEl = document.getElementById('playerMiddle');
        const playerBottomEl = document.getElementById('playerBottom');
        const botTopEl = document.getElementById('botTop');
        const botMiddleEl = document.getElementById('botMiddle');
        const botBottomEl = document.getElementById('botBottom');
        const newGameBtn = document.getElementById('newGameBtn');
        const arrangeBtn = document.getElementById('arrangeBtn');
        const playBtn = document.getElementById('playBtn');
        const messageEl = document.getElementById('message');
        const scoreTableEl = document.getElementById('scoreTable');

        // Инициализация новой игры
        function newGame() {
            // Создаем колоду
            deck = [];
            for (let suit of suits) {
                for (let rank of ranks) {
                    deck.push({ suit, rank });
                }
            }
            
            // Перемешиваем колоду
            shuffleDeck();
            
            // Раздаем карты
            playerHand = deck.slice(0, 13);
            botHand = deck.slice(13, 26);
            
            // Сортируем карты для удобства
            sortHand(playerHand);
            sortHand(botHand);
            
            // Очищаем поля
            playerFields = { top: [], middle: [], bottom: [] };
            botFields = { top: [], middle: [], bottom: [] };
            selectedCards = [];
            currentField = null;
            
            // Обновляем интерфейс
            updateHands();
            updateFields();
            updateControls();
            
            currentRound++;
            messageEl.textContent = `Раунд ${currentRound}. Выберите карты для верхнего, среднего или нижнего поля.`;
        }

        // Перемешивание колоды
        function shuffleDeck() {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        // Сортировка карт в руке
        function sortHand(hand) {
            hand.sort((a, b) => {
                const suitOrder = suits.indexOf(a.suit) - suits.indexOf(b.suit);
                if (suitOrder !== 0) return suitOrder;
                return ranks.indexOf(a.rank) - ranks.indexOf(b.rank);
            });
        }

        // Обновление отображения карт в руке
        function updateHands() {
            // Карты игрока
            playerHandEl.innerHTML = '';
            playerHand.forEach((card, index) => {
                const cardEl = createCardElement(card, index, true);
                playerHandEl.appendChild(cardEl);
            });
            
            // Карты бота (рубашкой вверх)
            botHandEl.innerHTML = '';
            botHand.forEach(() => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card card-back';
                cardEl.textContent = '?';
                botHandEl.appendChild(cardEl);
            });
        }

        // Создание элемента карты
        function createCardElement(card, index, clickable) {
            const cardEl = document.createElement('div');
            cardEl.className = `card ${card.suit}`;
            cardEl.textContent = `${card.rank}${suitSymbols[card.suit]}`;
            cardEl.dataset.index = index;
            
            if (clickable) {
                cardEl.addEventListener('click', () => toggleCardSelection(index));
            }
            
            return cardEl;
        }

        // Выбор/снятие выделения с карты
        function toggleCardSelection(index) {
            if (playerFields.top.length > 0 || playerFields.middle.length > 0 || playerFields.bottom.length > 0) {
                return; // Уже распределены, нельзя менять
            }
            
            const idx = selectedCards.indexOf(index);
            if (idx === -1) {
                selectedCards.push(index);
            } else {
                selectedCards.splice(idx, 1);
            }
            
            updateHands();
            updateControls();
        }

        // Обновление полей с картами
        function updateFields() {
            updateField(playerTopEl, playerFields.top);
            updateField(playerMiddleEl, playerFields.middle);
            updateField(playerBottomEl, playerFields.bottom);
            
            updateField(botTopEl, botFields.top);
            updateField(botMiddleEl, botFields.middle);
            updateField(botBottomEl, botFields.bottom);
        }

        // Обновление одного поля
        function updateField(fieldEl, cards) {
            fieldEl.innerHTML = '';
            const title = fieldEl.querySelector('.field-title').cloneNode(true);
            fieldEl.appendChild(title);
            
            cards.forEach((card, index) => {
                const cardEl = createCardElement(card, index, false);
                fieldEl.appendChild(cardEl);
            });
        }

        // Обновление состояния кнопок управления
        function updateControls() {
            // Подсвечиваем выбранные карты
            const cardElements = playerHandEl.querySelectorAll('.card');
            cardElements.forEach((el, index) => {
                if (selectedCards.includes(index)) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
            
            // Кнопка "Распределить карты"
            if (playerFields.top.length === 0 && playerFields.middle.length === 0 && playerFields.bottom.length === 0) {
                arrangeBtn.disabled = false;
                
                // Проверяем, можно ли распределить выбранные карты в текущее поле
                if (currentField === 'top' && selectedCards.length === 5) {
                    arrangeBtn.textContent = 'Распределить в верх (5 карт)';
                } else if (currentField === 'middle' && selectedCards.length === 5) {
                    arrangeBtn.textContent = 'Распределить в середину (5 карт)';
                } else if (currentField === 'bottom' && selectedCards.length === 3) {
                    arrangeBtn.textContent = 'Распределить в низ (3 карты)';
                } else {
                    arrangeBtn.textContent = 'Распределить карты';
                    arrangeBtn.disabled = true;
                }
            } else {
                arrangeBtn.disabled = true;
                arrangeBtn.textContent = 'Распределить карты';
            }
            
            // Кнопка "Сделать ход"
            playBtn.disabled = !(playerFields.top.length === 5 && playerFields.middle.length === 5 && playerFields.bottom.length === 3);
        }

        // Распределение карт по полям
        function arrangeCards() {
            if (!currentField || selectedCards.length === 0) return;
            
            // Проверяем соответствие количества карт выбранному полю
            if ((currentField === 'top' && selectedCards.length !== 5) ||
                (currentField === 'middle' && selectedCards.length !== 5) ||
                (currentField === 'bottom' && selectedCards.length !== 3)) {
                return;
            }
            
            // Переносим карты в выбранное поле
            const selectedCardsCopy = [...selectedCards].sort((a, b) => b - a); // Сортируем по убыванию для правильного удаления
            for (const index of selectedCardsCopy) {
                const card = playerHand.splice(index, 1)[0];
                playerFields[currentField].push(card);
            }
            
            // Сортируем карты в поле для лучшего отображения
            sortHand(playerFields[currentField]);
            
            // Сбрасываем выбор
            selectedCards = [];
            currentField = null;
            
            // Обновляем интерфейс
            updateHands();
            updateFields();
            updateControls();
            
            // Сообщение
            if (playerFields.top.length === 5 && playerFields.middle.length === 5 && playerFields.bottom.length === 3) {
                messageEl.textContent = 'Все карты распределены. Нажмите "Сделать ход" для подсчета очков.';
            } else {
                let nextField = '';
                if (playerFields.top.length === 0) nextField = 'верхнее (5 карт)';
                else if (playerFields.middle.length === 0) nextField = 'среднее (5 карт)';
                else if (playerFields.bottom.length === 0) nextField = 'нижнее (3 карты)';
                
                messageEl.textContent = `Выберите карты для ${nextField} поля.`;
            }
        }

        // Выбор поля для распределения карт
        function selectField(field) {
            if (playerFields.top.length > 0 && playerFields.middle.length > 0 && playerFields.bottom.length > 0) return;
            
            currentField = field;
            updateControls();
            
            let fieldName = '';
            let cardsNeeded = 0;
            
            if (field === 'top') {
                fieldName = 'верхнее';
                cardsNeeded = 5;
            } else if (field === 'middle') {
                fieldName = 'среднее';
                cardsNeeded = 5;
            } else if (field === 'bottom') {
                fieldName = 'нижнее';
                cardsNeeded = 3;
            }
            
            messageEl.textContent = `Выбрано ${fieldName} поле. Выберите ${cardsNeeded} карт и нажмите "Распределить карты".`;
        }

        // Ход бота - автоматическое распределение карт
        function botArrangeCards() {
            // Простая стратегия: сортируем карты и распределяем по силе
            sortHand(botHand);
            
            // Распределяем 3 самые сильные карты в низ
            botFields.bottom = botHand.splice(0, 3);
            
            // Распределяем 5 следующих по силе карт в середину
            botFields.middle = botHand.splice(0, 5);
            
            // Оставшиеся 5 карт идут в верх
            botFields.top = botHand.splice(0, 5);
            
            updateFields();
        }

        // Подсчет очков за комбинацию
        function evaluateCombination(cards) {
            // Простая реализация - считаем только старшинство карт
            let score = 0;
            for (const card of cards) {
                score += ranks.indexOf(card.rank) + 2; // 2=0, 3=1, ..., A=12 => +2 чтобы 2=2, A=14
            }
            return score;
        }

        // Сравнение двух комбинаций
        function compareCombinations(playerCards, botCards) {
            const playerScore = evaluateCombination(playerCards);
            const botScore = evaluateCombination(botCards);
            
            if (playerScore > botScore) return 1; // Игрок выиграл
            if (playerScore < botScore) return -1; // Бот выиграл
            return 0; // Ничья
        }

        // Подсчет очков за раунд
        function calculateScores() {
            let playerPoints = 0;
            let botPoints = 0;
            
            // Сравниваем верхние поля (5 карт)
            const topResult = compareCombinations(playerFields.top, botFields.top);
            if (topResult === 1) playerPoints++;
            else if (topResult === -1) botPoints++;
            
            // Сравниваем средние поля (5 карт)
            const middleResult = compareCombinations(playerFields.middle, botFields.middle);
            if (middleResult === 1) playerPoints++;
            else if (middleResult === -1) botPoints++;
            
            // Сравниваем нижние поля (3 карты)
            const bottomResult = compareCombinations(playerFields.bottom, botFields.bottom);
            if (bottomResult === 1) playerPoints++;
            else if (bottomResult === -1) botPoints++;
            
            // Проверяем "чистую победу" (выиграл все 3 поля)
            if (playerPoints === 3) playerPoints += 3; // Бонус за чистую победу
            if (botPoints === 3) botPoints += 3;
            
            return { playerPoints, botPoints };
        }

        // Завершение раунда
        function playRound() {
            // Бот распределяет свои карты
            botArrangeCards();
            
            // Подсчет очков
            const { playerPoints, botPoints } = calculateScores();
            
            // Сохраняем результат
            scores.push({ round: currentRound, player: playerPoints, bot: botPoints });
            updateScoreTable();
            
            // Показываем результат
            let resultMessage = `Раунд ${currentRound} завершен. `;
            if (playerPoints > botPoints) {
                resultMessage += `Вы выиграли ${playerPoints}:${botPoints}!`;
            } else if (playerPoints < botPoints) {
                resultMessage += `Бот выиграл ${botPoints}:${playerPoints}.`;
            } else {
                resultMessage += `Ничья ${playerPoints}:${botPoints}.`;
            }
            
            messageEl.textContent = resultMessage;
            
            // Обновляем кнопки
            playBtn.disabled = true;
        }

        // Обновление таблицы результатов
        function updateScoreTable() {
            scoreTableEl.innerHTML = '';
            
            for (const score of scores) {
                const row = document.createElement('tr');
                
                const roundCell = document.createElement('td');
                roundCell.textContent = score.round;
                row.appendChild(roundCell);
                
                const playerCell = document.createElement('td');
                playerCell.textContent = score.player;
                row.appendChild(playerCell);
                
                const botCell = document.createElement('td');
                botCell.textContent = score.bot;
                row.appendChild(botCell);
                
                scoreTableEl.appendChild(row);
            }
            
            // Итоговая строка
            if (scores.length > 0) {
                const totalRow = document.createElement('tr');
                
                const totalLabelCell = document.createElement('td');
                totalLabelCell.textContent = 'Всего';
                totalRow.appendChild(totalLabelCell);
                
                const totalPlayer = scores.reduce((sum, score) => sum + score.player, 0);
                const totalPlayerCell = document.createElement('td');
                totalPlayerCell.textContent = totalPlayer;
                totalRow.appendChild(totalPlayerCell);
                
                const totalBot = scores.reduce((sum, score) => sum + score.bot, 0);
                const totalBotCell = document.createElement('td');
                totalBotCell.textContent = totalBot;
                totalRow.appendChild(totalBotCell);
                
                scoreTableEl.appendChild(totalRow);
            }
        }

        // Обработчики событий
        newGameBtn.addEventListener('click', newGame);
        arrangeBtn.addEventListener('click', arrangeCards);
        playBtn.addEventListener('click', playRound);
        
        // Обработчики выбора полей
        playerTopEl.addEventListener('click', () => selectField('top'));
        playerMiddleEl.addEventListener('click', () => selectField('middle'));
        playerBottomEl.addEventListener('click', () => selectField('bottom'));
        
        // Инициализация
        updateControls();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Китайский Ананас II — Optimized Edition</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #1a1a1a;
      color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2, h3 {
      text-align: center;
      margin-top: 20px;
      color: #00ffcc;
    }

    .game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 1000px;
      width: 100%;
      padding: 20px;
    }

    .player-zone, .bot-zone {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      margin-bottom: 40px;
    }

    .hand, .dropzone {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .card {
      width: 60px;
      height: 90px;
      background: white;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
      color: black;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
      cursor: grab;
      transition: transform 0.2s ease;
    }

    .card:hover {
      transform: scale(1.05);
    }

    .dropzone {
      min-height: 100px;
      background: #2e2e2e;
      border: 2px dashed #00ffcc;
      padding: 10px;
      border-radius: 8px;
      margin-top: 5px;
    }

    .row-label {
      font-size: 16px;
      color: #ccc;
      margin-top: 10px;
    }

    .combo-name, .row-result {
      font-size: 14px;
      color: #aaa;
      margin-top: 2px;
    }

    .score-tag {
      font-size: 16px;
      margin-left: 10px;
      font-weight: bold;
    }

    .win-score {
      color: #00ff88;
    }

    .lose-score {
      color: #ff4d4d;
    }

    button {
      padding: 10px 20px;
      background-color: #00ffcc;
      color: #000;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #00d6aa;
    }

    .result {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
    }

    .win {
      color: #00ff88;
    }

    .loss {
      color: #ff4d4d;
    }

    .stats {
      margin-top: 10px;
      font-size: 16px;
      color: #aaa;
    }

    .discarded-card {
      opacity: 0.4;
      pointer-events: none;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div class="game-container">

  <!-- Бот -->
  <div class="bot-zone">
    <h3>🤖 Бот</h3>

    <div style="display: flex; align-items: center;">
      <div class="row-label">⬆ Верх (3 карты)</div>
      <span class="score-tag" id="bot-top-score"></span>
    </div>
    <div id="bot-top" class="dropzone"></div>
    <div id="bot-top-combo" class="combo-name"></div>

    <div style="display: flex; align-items: center;">
      <div class="row-label">🟰 Средний (5 карт)</div>
      <span class="score-tag" id="bot-middle-score"></span>
    </div>
    <div id="bot-middle" class="dropzone"></div>
    <div id="bot-middle-combo" class="combo-name"></div>

    <div style="display: flex; align-items: center;">
      <div class="row-label">⬇ Низ (5 карт)</div>
      <span class="score-tag" id="bot-bottom-score"></span>
    </div>
    <div id="bot-bottom" class="dropzone"></div>
    <div id="bot-bottom-combo" class="combo-name"></div>
  </div>

  <!-- Игрок -->
  <div class="player-zone">
    <h3>🃏 Ваши начальные карты</h3>
    <div class="hand" id="player-initial-cards"></div>

    <button onclick="startPlayerTurn()">✅ Готово</button>

    <h3 class="hidden" id="extra-title">➕ Дополнительные карты</h3>
    <div class="hand hidden" id="player-extra-cards"></div>

    <h3 id="discard-zone-label" class="hidden">🪫 Сброшенные карты</h3>
    <div class="hand hidden" id="discard-zone"></div>

    <p id="discard-info" class="hidden">Выберите карту для сброса:</p>
    <button id="discard-btn" class="hidden" onclick="discardCard()">🗑️ Сбросить</button>

    <h3 class="hidden" id="layout-title">🧮 Ваша раскладка</h3>
    <div id="layout-section" class="hidden" style="width: 100%;">
      <div style="display: flex; align-items: center;">
        <div class="row-label">⬆ Верх (3 карты)</div>
        <span class="score-tag" id="top-score"></span>
      </div>
      <div id="top" class="dropzone"></div>
      <div id="top-combo" class="combo-name"></div>

      <div style="display: flex; align-items: center;">
        <div class="row-label">🟰 Средний ряд (5 карт)</div>
        <span class="score-tag" id="middle-score"></span>
      </div>
      <div id="middle" class="dropzone"></div>
      <div id="middle-combo" class="combo-name"></div>

      <div style="display: flex; align-items: center;">
        <div class="row-label">⬇ Низ (5 карт)</div>
        <span class="score-tag" id="bottom-score"></span>
      </div>
      <div id="bottom" class="dropzone"></div>
      <div id="bottom-combo" class="combo-name"></div>

      <button onclick="finishGame()">🏁 Завершить игру</button>
    </div>

    <p id="foul-error" style="color: red; font-weight: bold;"></p>
    <p id="result" class="result"></p>
    <p id="stats" class="stats"></p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pokersolver @2.2.0/PokerSolver.min.js"></script>
<script>
const suits = ['♠', '♣', '♦', '♥'];
const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];

let deck = [];
let playerInitial = [], playerExtra = [], playerFinal = [];
let botInitial = [], botExtra = [], botFinal = [];

// Создание колоды
function createDeck() {
  let d = [];
  for (let s of suits) {
    for (let r of ranks) {
      d.push(r + s);
    }
  }
  return d;
}

// Перемешивание
function shuffle(deck) {
  for (let i = deck.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [deck[i], deck[j]] = [deck[j], deck[i]];
  }
  return deck;
}

// Выбор уникальных карт
function drawUnique(count) {
  let result = [];
  while (result.length < count && deck.length > 0) {
    let card = deck.splice(Math.floor(Math.random() * deck.length), 1)[0];
    result.push(card);
  }
  return result;
}

// Отображение карт
function renderCards(containerId, cards) {
  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = '';
  for (let card of cards) {
    let div = document.createElement('div');
    div.className = 'card';
    div.textContent = card;
    div.draggable = true;

    div.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', card);
    });

    container.appendChild(div);
  }
}

// --- Обработчики drop ---
document.querySelectorAll('[data-drop]').forEach(area => {
  area.addEventListener('dragover', e => e.preventDefault());
  area.addEventListener('drop', e => {
    e.preventDefault();
    const cardText = e.dataTransfer.getData('text/plain');

    // Ищем оригинал
    const cardDiv = document.querySelector(`[draggable][data-card='${cardText}']`) || 
                    document.querySelector(`[draggable]:not(.discarded-card):contains('${cardText}')`);

    const targetArea = e.target.closest('.dropzone');
    if (!targetArea) return;

    // Клонируем и удаляем оригинал
    if (cardDiv && !targetArea.querySelector(`[data-card='${cardText}']`)) {
      const clone = cardDiv.cloneNode(true);
      clone.setAttribute('data-card', cardText);
      clone.draggable = false;
      targetArea.appendChild(clone);
      cardDiv.remove();
    }
  });
});

// --- Функции игры ---
window.startPlayerTurn = function () {
  playerExtra = drawUnique(3);

  const extraContainer = document.getElementById('player-extra-cards');
  extraContainer.innerHTML = '';
  playerExtra.forEach(card => {
    let div = document.createElement('div');
    div.className = 'card';
    div.textContent = card;
    div.draggable = true;

    div.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', card);
    });

    extraContainer.appendChild(div);
  });

  document.getElementById('extra-title').classList.remove('hidden');
  extraContainer.classList.remove('hidden');
  document.getElementById('discard-zone-label').classList.remove('hidden');
  document.getElementById('discard-zone').classList.remove('hidden');
  document.getElementById('discard-info').classList.remove('hidden');
  document.getElementById('discard-btn').classList.remove('hidden');
  document.getElementById('layout-section').classList.remove('hidden');
};

window.discardCard = function () {
  let extraCards = Array.from(document.getElementById('player-extra-cards').children);
  let discardZone = document.getElementById('discard-zone');

  alert("Нажмите на карту, чтобы сбросить её");

  extraCards.forEach(card => {
    card.onclick = () => {
      if (!card.classList.contains('discarded-card')) {
        card.classList.add('discarded-card');
        card.style.opacity = '0.4';
        card.style.pointerEvents = 'none';
        card.draggable = false;

        let clone = card.cloneNode(true);
        clone.setAttribute('data-card', card.textContent);
        discardZone.appendChild(clone);

        card.remove(); // Удаляем из доп. карт
      }
    };
  });
};

window.finishGame = function () {
  const topPlayer = getCardsFromZone('top');
  const middlePlayer = getCardsFromZone('middle');
  const bottomPlayer = getCardsFromZone('bottom');

  if (topPlayer.length !== 3 || middlePlayer.length !== 5 || bottomPlayer.length !== 5) {
    alert("Пожалуйста, положите ровно:\n- 3 карты в Верх,\n- 5 карт в Средний,\n- 5 карт в Низ.");
    return;
  }

  const strengthTop = getStrength(topPlayer);
  const strengthMiddle = getStrength(middlePlayer);
  const strengthBottom = getStrength(bottomPlayer);

  if (strengthTop >= strengthMiddle || strengthMiddle >= strengthBottom) {
    document.getElementById("foul-error").textContent = "❌ Вы сделали фол! Верх < Средний < Низ";
  //  return;
  } else {
    document.getElementById("foul-error").textContent = "";
  }

  const botLayout = botPlay();

  const resTop = compare(strengthTop, botLayout.topStrength);
  const resMiddle = compare(strengthMiddle, botLayout.middleStrength);
  const resBottom = compare(strengthBottom, botLayout.bottomStrength);

  // Показываем результаты по рядам
  document.getElementById("top-score").textContent = resTop === 1 ? "+1" : resTop === -1 ? "-1" : "0";
  document.getElementById("top-score").className = resTop === 1 ? "score-tag win-score" : resTop === -1 ? "score-tag lose-score" : "score-tag";

  document.getElementById("middle-score").textContent = resMiddle === 1 ? "+1" : resMiddle === -1 ? "-1" : "0";
  document.getElementById("middle-score").className = resMiddle === 1 ? "score-tag win-score" : resMiddle === -1 ? "score-tag lose-score" : "score-tag";

  document.getElementById("bottom-score").textContent = resBottom === 1 ? "+1" : resBottom === -1 ? "-1" : "0";
  document.getElementById("bottom-score").className = resBottom === 1 ? "score-tag win-score" : resBottom === -1 ? "score-tag lose-score" : "score-tag";

  let scorePlayer = 0, scoreBot = 0;

  if (resTop === 1) scorePlayer++;
  else if (resTop === -1) scoreBot++;

  if (resMiddle === 1) scorePlayer++;
  else if (resMiddle === -1) scoreBot++;

  if (resBottom === 1) scorePlayer++;
  else if (resBottom === -1) scoreBot++;

  let win = scorePlayer > scoreBot;
  if (win) {
    document.getElementById('result').className = 'result win';
    document.getElementById('result').textContent = `🎉 Вы победили! ${scorePlayer} : ${scoreBot}`;
  } else {
    document.getElementById('result').className = 'result loss';
    document.getElementById('result').textContent = `😢 Вы проиграли. ${scorePlayer} : ${scoreBot}`;
  }

  saveStats(win);
};

function getCardsFromZone(zoneId) {
  return Array.from(document.getElementById(zoneId).children)
              .map(c => c.getAttribute('data-card') || c.textContent);
}

function getHandName(cards) {
  try {
    return PokerEvaluator.evaluateHand(prepareCards(cards)).name;
  } catch (e) {
    return "Неизвестно";
  }
}

function getStrength(cards) {
  try {
    return PokerEvaluator.evaluateHand(prepareCards(cards)).value;
  } catch (e) {
    return 0;
  }
}

function prepareCards(cards) {
  return cards.map(c => c.replace('♠', 's').replace('♣', 'c').replace('♦', 'd').replace('♥', 'h'));
}

function getPokerValue(card) {
  const valueMap = {
    '2': 2, '3': 3, '4': 4, '5': 5,
    '6': 6, '7': 7, '8': 8, '9': 9,
    '10': 10, 'J': 11, 'Q': 12, 'K': 13, 'A': 14
  };
  return valueMap[card.slice(0, card.length - 1)] || 0;
}

function compare(p, b) {
  return p > b ? 1 : p < b ? -1 : 0;
}

function loadStats() {
  let stats = JSON.parse(localStorage.getItem("chinese_poker_stats") || '{"wins":0,"losses":0}');
  document.getElementById("stats").textContent = `Побед: ${stats.wins} | Поражений: ${stats.losses}`;
}

function saveStats(win) {
  let stats = JSON.parse(localStorage.getItem("chinese_poker_stats") || '{"wins":0,"losses":0}');
  if (win) stats.wins++;
  else stats.losses++;
  localStorage.setItem("chinese_poker_stats", JSON.stringify(stats));
  loadStats();
}

// Логика бота
function botPlay() {
  botExtra = drawUnique(3);
  let discardIndex = Math.floor(Math.random() * botExtra.length);
  botExtra.splice(discardIndex, 1); // Сбрасывает одну карту

  let botAll = [...botInitial, ...botExtra];
  botAll.sort((a, b) => getPokerValue(b) - getPokerValue(a));

  let top = botAll.slice(0, 3);
  let middle = botAll.slice(3, 8);
  let bottom = botAll.slice(8, 13);

  renderCards('bot-top', top);
  renderCards('bot-middle', middle);
  renderCards('bot-bottom', bottom);

  document.getElementById("bot-top-combo").textContent = getHandName(top);
  document.getElementById("bot-middle-combo").textContent = getHandName(middle);
  document.getElementById("bot-bottom-combo").textContent = getHandName(bottom);

  return {
    topStrength: getStrength(top),
    middleStrength: getStrength(middle),
    bottomStrength: getStrength(bottom),
    topCombo: getHandName(top),
    middleCombo: getHandName(middle),
    bottomCombo: getHandName(bottom)
  };
}

// --- Инициализация игры ---
function resetGame() {
  deck = shuffle(createDeck());

  playerInitial = drawUnique(5);
  botInitial = drawUnique(5);

  clearElement('player-initial-cards');
  clearElement('bot-initial-cards');
  clearElement('player-extra-cards');
  clearElement('discard-zone');
  clearElement('top');
  clearElement('middle');
  clearElement('bottom');
  clearElement('bot-top');
  clearElement('bot-middle');
  clearElement('bot-bottom');

  document.getElementById('extra-title')?.classList.add('hidden');
  document.getElementById('discard-zone-label')?.classList.add('hidden');
  document.getElementById('discard-info')?.classList.add('hidden');
  document.getElementById('discard-btn')?.classList.add('hidden');
  document.getElementById('layout-section')?.classList.add('hidden');

  renderCards('player-initial-cards', playerInitial);
  renderCards('bot-initial-cards', botInitial);
}

function clearElement(id) {
  const el = document.getElementById(id);
  if (el) el.innerHTML = '';
}

function initDropZones() {
  document.querySelectorAll('.dropzone').forEach(area => {
    area.addEventListener('dragover', e => e.preventDefault());
    area.addEventListener('drop', handleDrop);
  });
}

function handleDrop(e) {
  e.preventDefault();
  const cardText = e.dataTransfer.getData('text/plain');
  const cardDiv = document.querySelector(`.card:not(.discarded-card):not([data-card])`);
  const target = e.currentTarget;

  if (cardDiv && !target.querySelector(`[data-card='${cardText}']`)) {
    const clone = cardDiv.cloneNode(true);
    clone.setAttribute('data-card', cardText);
    clone.draggable = false;
    target.appendChild(clone);
    cardDiv.remove();
  }
}

// Автозапуск
document.addEventListener("DOMContentLoaded", function () {
  loadStats();
  resetGame();
  initDropZones();
});
</script>

<!-- Для отображения статистики -->
<p id="stats" class="stats"></p>

</body>
</html>
